{{define "title"}}Expeses{{end}}
{{define "css"}}/static/css/expenses.css{{end}}

{{define "main"}}
  {{ template "expenses/nav" "index" }}

  {{if gt (len .Banner.Icon) 0}}
    {{template "banner" .Banner}}
  {{end}}

  <!-- Filter Bar - Always visible at top -->
  <form method="GET" action="/expenses" class="filter-bar" style="margin-bottom: 2rem; padding: 1rem; border: 1px solid #ddd; border-radius: 4px; background-color: #f9f9f9;">
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
          <!-- Description filter -->
          <div>
              <label for="description" style="display: block; margin-bottom: 0.25rem; font-weight: bold;">Description</label>
              <input type="text"
                     name="description"
                     id="description"
                     placeholder="Search..."
                     style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;"
                     value="{{if .Filter.Description}}{{.Filter.Description}}{{end}}">
          </div>

          <!-- Source filter -->
          <div>
              <label for="source" style="display: block; margin-bottom: 0.25rem; font-weight: bold;">Source</label>
              <input type="text"
                     name="source"
                     id="source"
                     placeholder="Search..."
                     style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;"
                     value="{{if .Filter.Source}}{{.Filter.Source}}{{end}}">
          </div>

          <!-- Amount min filter -->
          <div>
              <label for="amount_min" style="display: block; margin-bottom: 0.25rem; font-weight: bold;">Amount Min</label>
              <input type="number"
                     name="amount_min"
                     id="amount_min"
                     step="0.01"
                     placeholder="0.00"
                     style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;"
                     value="{{if .Filter.AmountMin}}{{amountToDollars .Filter.AmountMin}}{{end}}">
          </div>

          <!-- Amount max filter -->
          <div>
              <label for="amount_max" style="display: block; margin-bottom: 0.25rem; font-weight: bold;">Amount Max</label>
              <input type="number"
                     name="amount_max"
                     id="amount_max"
                     step="0.01"
                     placeholder="0.00"
                     style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;"
                     value="{{if .Filter.AmountMax}}{{amountToDollars .Filter.AmountMax}}{{end}}">
          </div>

          <!-- Date from filter -->
          <div>
              <label for="date_from" style="display: block; margin-bottom: 0.25rem; font-weight: bold;">Date From</label>
              <input type="date"
                     name="date_from"
                     id="date_from"
                     style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;"
                     value="{{if .Filter.DateFrom}}{{formatDate .Filter.DateFrom}}{{end}}">
          </div>

          <!-- Date to filter -->
          <div>
              <label for="date_to" style="display: block; margin-bottom: 0.25rem; font-weight: bold;">Date To</label>
              <input type="date"
                     name="date_to"
                     id="date_to"
                     style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;"
                     value="{{if .Filter.DateTo}}{{formatDate .Filter.DateTo}}{{end}}">
          </div>

          <!-- Sort options -->
          <div>
              <label for="sort" style="display: block; margin-bottom: 0.25rem; font-weight: bold;">Sort By</label>
              <select name="sort" id="sort" style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;">
                  <option value="date:desc" {{if eq .Sort.String "date:desc"}}selected{{end}}>Date (Newest)</option>
                  <option value="date:asc" {{if eq .Sort.String "date:asc"}}selected{{end}}>Date (Oldest)</option>
                  <option value="amount:desc" {{if eq .Sort.String "amount:desc"}}selected{{end}}>Amount (High to Low)</option>
                  <option value="amount:asc" {{if eq .Sort.String "amount:asc"}}selected{{end}}>Amount (Low to High)</option>
              </select>
          </div>
      </div>

      <!-- Actions -->
      <div style="margin-top: 1rem; display: flex; gap: 1rem;">
          <button type="submit" style="padding: 0.5rem 1rem; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Apply Filters</button>
          <a href="/expenses" style="padding: 0.5rem 1rem; background-color: #6c757d; color: white; border-radius: 4px; text-decoration: none; display: inline-block;">Clear All</a>
      </div>
  </form>

  <form class='search-form'>
    <div class="form-group">
      <input type='search' name='q' required>
    </div>
    <button
      class="btn-primary"
      hx-post="/expense/search"
      hx-target="#page"
      hx-swap="outerHTML"
      type="submit">
      Search
    </button>
  </form>

  {{ if eq (len .Error) 0 }}
    {{ if gt (len .Query) 0 }}
    <h2> Results for {{.Query}} </h2>
    {{ end }}
    <div class="expenses-container">
        {{range $year := .Years}}
          {{$currentYear := (eq $year $.CurrentYear)}}
        
          <div class="expense-year">
            <div class="year-header" data-toggle>
              <h2>{{$year}}</h2>
            </div>
            
            <div class="expense-list {{if not $currentYear}}collapsed{{end}}">
              {{range $month := $.Months}}
                {{$currentMonth := (and (eq $month $.CurrentMonth) $currentYear)}}
                {{$expenses := index $.Expenses $year $month}}
                {{if gt (len $expenses) 0}}
                  <div class="month-header" data-toggle>
                    <h3>{{$month}}</h3>
                  </div>
                
                  <ul class="expense-list {{if not $currentMonth}}collapsed{{end}}">
                    {{range $expense := $expenses}}
                      <li class="expense-item">
                        <div class="text-gray-500 text-sm">{{$expense.Date.Format "2006-01-02"}}</div>
                        <div class="mx-4">
                          <p>{{$expense.Description}}</p>
                          <div class="expense-meta">
                            {{if $expense.Category}}
                              <span class="badge">{{$expense.Category.Name}}</span>
                            {{else}}
                              <span class="badge"></span>
                            {{end}}
                            <span class="font-italic">via {{$expense.Source}}</span>
                          </div>
                        </div>
                        <p class="amount ta-center {{if gt $expense.Amount 0}}income{{else}}expense{{end}}">
                          <b>{{formatMoney $expense.Amount "." ","}}â‚¬</b>
                        </p>
                        <div class="form-actions mt-0">
                          <a 
                            class="btn-danger btn-small"
                            hx-delete="/expense/{{.Expense.ID}}"
                            hx-target="#page" 
                            hx-swap="outerHTML show:window:top"
                            hx-confirm="Are you sure you want to delete the expense? This action cannot be undone.">
                            Delete
                          </a>
                          <a class="btn-secondary btn-small" href="/expense/{{$expense.ID}}">
                            Edit
                          </a>
                        </div>
                      </li>
                    {{end}}
                  </ul>
                {{end}}
              {{end}}
            </div>
          </div>
        {{end}}
      </ul>
    </div>
  {{ else }}
    {{template "error" .Error}}
  {{ end }}
{{end}}
 
